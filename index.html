<!doctype html>
<meta charset="utf-8">

<select id=role>
  <option value=en selected>Alice (speaks English)</option>
  <option value=zh>Bob    (speaks 中文)</option>
</select>
<button id=start>start</button>

<script type=module>
/* ---------------- little helpers ------------------------------------ */
const log = (...a) => console.log(`[${new Date().toISOString()}]`, ...a);
const uuid = () => crypto.randomUUID();                 // RFC-4122 v4

start.onclick = async () => {
  /* who speaks what? --------------------------------------------------- */
  const from = role.value;            // "en" or "zh"
  const to   = from === "en" ? "zh" : "en";
  log("UI ­→ start; from:", from, "to:", to);

  /* obtain (or reuse) an OpenAI realtime session ---------------------- */
  const {client_secret:{value:key}} =
        await (await fetch("/session")).json();
  log("SESSION ­→ received client secret…");

  /* ------------------- peer connection -------------------------------- */
  const pc = new RTCPeerConnection();
  window.pc = pc;                         // inspect from dev-tools

  /* very verbose state tracing */
  const dump = () => log("PC state", {
    signaling     : pc.signalingState,
    iceGathering  : pc.iceGatheringState,
    iceConnection : pc.iceConnectionState,
    connection    : pc.connectionState });
  pc.onsignalingstatechange     =
  pc.onicegatheringstatechange  =
  pc.oniceconnectionstatechange =
  pc.onconnectionstatechange    = dump;

  pc.onicecandidate = ({candidate}) => log("PC icecandidate:", candidate);

  /* remote audio from OpenAI ------------------------------------------ */
  pc.ontrack = ({track, streams:[stream]}) => {
    log("PC ontrack → kind:", track.kind, "id:", track.id);

    track.onmute   = () => log("   track muted");
    track.onunmute = () => log("   track unmuted");
    track.onended  = () => log("   track ended");

    const audio = Object.assign(new Audio(), {autoplay:true, srcObject:stream});
    document.body.appendChild(audio);
  };

  /* microphone -------------------------------------------------------- */
  const gum = await navigator.mediaDevices.getUserMedia({
    audio: {echoCancellation:true, noiseSuppression:true}
  });
  const [mic] = gum.getAudioTracks();
  log("GUM ­→ got mic track:", mic.label || mic.id);
  mic.onended = () => log("mic track ended");
  pc.addTrack(mic, gum);

  /* ----------------- data-channel ------------------------------------ */
  const dc = pc.createDataChannel("oai-events");
  window.dc = dc;

  dc.addEventListener("open" , () => log("DC open"));
  dc.addEventListener("close", () => log("DC close"));
  dc.addEventListener("error", e => log("DC error", e));

  let prefixSent = false;      // make sure we send exactly once
  let sessionId  = null;       // filled when we get session.created

  dc.addEventListener("message", ev => {
    let msg;
    try { msg = JSON.parse(ev.data); log("DC ⇠", msg); }
    catch {        log("DC ⇠ (raw)", ev.data); return; }

    /* wait until the back-end tells us the session id ------------------ */
    if (msg.type === "session.created") {
      sessionId = msg.session.id;
      if (!prefixSent) {
        const prefix = (to === "en")
          ? "translate to english"
          : "translate to chinese";

        log("DC ⇢ sending persistent user prefix:", prefix);

        dc.send(JSON.stringify({
          type     : "message.add",
          event_id : uuid(),               // <-- REQUIRED
          session_id: sessionId,           // <-- REQUIRED
          message  : {
            id     : uuid(),               // <-- REQUIRED
            role   : "user",
            content: prefix
          }
        }));
        prefixSent = true;
      }
    }
  });

  /* ------------------- SDP offer / answer ---------------------------- */
  log("PC ­→ createOffer");
  await pc.setLocalDescription(await pc.createOffer());
  log("PC ­→ localDescription set (length", pc.localDescription.sdp.length, ")");

  const answerSDP = await (await fetch(
    "https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2025-06-03",
    {
      method : "POST",
      headers: {
        Authorization : `Bearer ${key}`,
        "Content-Type": "application/sdp"
      },
      body   : pc.localDescription.sdp
    }
  )).text();
  log("NET ⇠ received answer SDP (length", answerSDP.length, ")");

  await pc.setRemoteDescription({type:"answer", sdp:answerSDP});
  log("PC ­→ remoteDescription set — negotiation complete");
};
</script>