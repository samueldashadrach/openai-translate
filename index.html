<!doctype html><meta charset="utf-8">
<select id=role>
  <option value=en>Alice (speaks English)</option>
  <option value=zh>Bob   (speaks 中文)</option>
</select>
<button id=start>start</button>

<script type=module>
start.onclick = async () => {
  const from = role.value, to = from === "en" ? "zh" : "en";

  const {client_secret:{value:key}} = await (await fetch("/session")).json();

  const pc = new RTCPeerConnection();

  pc.ontrack = ev => {
    const a = new Audio();
    a.autoplay = true;
    a.srcObject = ev.streams[0];
    document.body.appendChild(a);                  // keep element alive
  };

  pc.addTrack(
    (await navigator.mediaDevices.getUserMedia({
      audio: {echoCancellation:true, noiseSuppression:true}
    })).getAudioTracks()[0]
  );

  // pc.addTrack(
  //   (await navigator.mediaDevices.getUserMedia({audio:true}))
  //     .getAudioTracks()[0]
  // );

  const dc = pc.createDataChannel("oai-events");
  dc.onopen = () => dc.send(JSON.stringify({
    type: "session.update",
    session: {
      instructions:
        `You are a real-time interpreter.
         If the speaker talks in ${from}, reply only in ${to};
         if the speaker talks in ${to}, reply only in ${from}.`
    }
  }));

  await pc.setLocalDescription(await pc.createOffer());
  const answerSDP = await (await fetch(
    "https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2025-06-03",
    {
      method : "POST",
      headers: { Authorization:`Bearer ${key}`, "Content-Type":"application/sdp" },
      body   : pc.localDescription.sdp
    }
  )).text();
  await pc.setRemoteDescription({type:"answer", sdp:answerSDP});
};
</script>